2024년 7월 22 구조 변경

# 변경사항
1. 사용자 인증과 조회를  모듈로 분할, 사용자 정보또한 다른 db로 분할
2. 다중 웹소켓서버 구현 구조 변경
3. 웹소켓 세션 실행 프로세스 변경


## 1. 사용자 모듈 분할
유동엽씨의 의견이 들어왔다.   
사용자 모듈을 분할하면 많은 장점이 있다고.   
장단점을 비교하니 그 의견이 맞다고 생각하여 모듈을 분할한다.   
업무량 증가는 토이프로젝트니 예외로 친다.


>사용자 모듈 분할 시 장점
> 1. 장애 대응성
> 2. 부하 분산
> 
> 단점
> 1. 복잡성

>db 분할 시 장점
> 1. 보안성 증대
> 2. 부하 분산
>
> 단점
> 1. 복잡성

특히 db는 스케일아웃이 어렵기에 나누면 더 좋다고 본다.


## 2. 다중 웹소켓서버 구현 구조 변경
기존에 조사할 때는 MQ를 통한 채팅 구현이 많아 redis pub/sub 또는 kafka를 이용해서 여러개의 웹소켓 서버일 때를 처리하려고 했다.   
그러다 채팅 기능에 MQ를 넣는 것이 맞는가에 대한 의문이 들었다.   
어느 방식이 좋은지는 테스트해보지 않았으나, session info 를 기준으로 구현한다면 몇가지의 장점이 있기에 다음과 같이 구조를 변경하려고 한다.  
웹소켓 접속 시 session info 를 따로 저장한다. 이후 한 서버로 메세지가 들어오면 해당 채팅방의 사용자리스트를 가지고 session info를 조회한다.
만약 접속중이라면 정보가 있을 것이다. 비접속 중이면 접속 시 채팅내용을 가져오는 별도의 프로세스를 탄다. 
접속중이면, 어디의 서버와 연결되어있는지를 알 수 있기에 해당 서버에 http 메세지를 보낸다.

위 방식대로 한다면 다음과 같은 장점이 있다.
1. 메세지 동시성 처리를 직접 구현해볼 기회
2. http 대신 다른 프로토콜을 구현해볼 기회 ex)http3, 커스텀 프로토콜(loco 프로토콜처럼) 



## 3. 웹소켓 세션 실행 프로세스 변경  
기존에 단순이 방마다 웹소켓 연결을 하면 된다고 생각했다. 이에 코드를 작성하면서 시나리오를 예상해보니 문제가 있었다.

> 기존 시나리오와 문제점
> 1. 하나의 채팅 창을 열면 하나의 ws세션이 생기므로 여러개를 열면 여러 세션이 생긴다.
> 2. 메인 페이지에 채팅방 리스트가 있는데 여기도 채팅 미리보기가 있을 예정이고, 그렇기에 ws세션이 연결되어야 한다.
> 3. 그렇다면 메인페이지에서 하나의 세션만 열고 room id를 통해서 채팅내용을 처리하면 되지 않을까?

불필요한 ws세션이 있다 판단하여 하나의 세션을 열고 각 채팅방에 전달하는 방식을 하면 하나의 ws세션만 열면 된다고 생각한다.   
프론트를 웹으로 구현하기에 팝업창으로 부모와 자식 간 데이터를 주고받으며, 메세지의 roomId값을 기준으로 어떤 자식에게 값을 전달할지를 구분한다. 
